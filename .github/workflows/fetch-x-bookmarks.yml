name: Fetch X Bookmarks

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 9:00 AM UTC (adjust timezone as needed)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering from GitHub Actions UI

permissions:
  contents: write # Required to commit and push changes

jobs:
  fetch-bookmarks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Debug - Show environment info
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Directory contents:"
          ls -la

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "Dependencies installed successfully"
          echo "Installed packages:"
          npm list --depth=0 || true

      - name: Debug - Verify secrets and config
        run: |
          echo "Checking environment variables..."
          echo "X_USERNAME: ${{ secrets.X_USERNAME || 'Abhiram2k03' }}"
          echo "MAX_BOOKMARKS: ${{ secrets.MAX_BOOKMARKS || '10' }}"
          if [ -z "${{ secrets.X_OAUTH2_ACCESS_TOKEN }}" ]; then
            echo "⚠️ Warning: X_OAUTH2_ACCESS_TOKEN is not set!"
          else
            echo "✅ X_OAUTH2_ACCESS_TOKEN is set"
          fi
          if [ -z "${{ secrets.X_OAUTH2_REFRESH_TOKEN }}" ]; then
            echo "⚠️ Warning: X_OAUTH2_REFRESH_TOKEN is not set!"
          else
            echo "✅ X_OAUTH2_REFRESH_TOKEN is set"
          fi
          if [ -z "${{ secrets.X_CLIENT_ID }}" ]; then
            echo "⚠️ Warning: X_CLIENT_ID is not set!"
          else
            echo "✅ X_CLIENT_ID is set"
          fi

      - name: Fetch X bookmarks
        env:
          X_OAUTH2_ACCESS_TOKEN: ${{ secrets.X_OAUTH2_ACCESS_TOKEN }}
          X_OAUTH2_REFRESH_TOKEN: ${{ secrets.X_OAUTH2_REFRESH_TOKEN }}
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_USERNAME: ${{ secrets.X_USERNAME || 'Abhiram2k03' }}
          MAX_BOOKMARKS: ${{ secrets.MAX_BOOKMARKS || '10' }}
          DEBUG: 'true'
        run: |
          echo "Starting X bookmarks fetch..."
          npm run fetch-bookmarks
          echo "Fetch completed"

      - name: Debug - Show generated files
        run: |
          echo "Checking for generated files..."
          echo "Contents of src/pages/posts/:"
          ls -la src/pages/posts/ 2>/dev/null || echo "Directory does not exist"
          echo "\nContents of src/data/:"
          ls -la src/data/ 2>/dev/null || echo "Directory does not exist"

      - name: Check for changes
        id: git-check
        run: |
          echo "Git status:"
          git status
          echo "\nGit diff:"
          git diff
          if [ -n "$(git status --porcelain)" ]; then
            echo "✅ Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          echo "Configuring git..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          echo "Adding files..."
          git add src/data/posts.ts src/pages/posts/
          echo "Files added:"
          git diff --cached --stat
          echo "Committing changes..."
          git commit -m "chore: add blog posts from X bookmarks [skip ci]"
          echo "Pushing to remote..."
          git push
          echo "✅ Successfully pushed changes"

      - name: Workflow summary
        if: always()
        run: |
          echo "### Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Username**: ${{ secrets.X_USERNAME || 'Abhiram2k03' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Bookmarks**: ${{ secrets.MAX_BOOKMARKS || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.git-check.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
